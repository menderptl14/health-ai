{% extends "base.html" %}
{% block title %}Diet & Fitness{% endblock %}
{% block page_title %}AI Diet & Fitness Planner{% endblock %}
{% block page_subtitle %}Get a personalized nutrition and workout plan generated by AI{% endblock %}

{% block content %}
<div class="grid grid-2">
  <div>
    <div class="card">
      <div class="card-label">Your Profile</div>
      <div class="card-title mt-1">Plan Personalization</div>
      <div class="mt-4">
        <div class="form-group">
          <label>Primary Goal</label>
          <select id="goal">
            <option value="Weight Loss">üî• Weight Loss</option>
            <option value="Muscle Gain">üí™ Muscle Gain</option>
            <option value="Maintain Weight">‚öñÔ∏è Maintain Weight</option>
            <option value="Improve Fitness">üèÉ Improve Overall Fitness</option>
            <option value="Build Endurance">üö¥ Build Endurance</option>
            <option value="Improve Health">‚ù§Ô∏è General Health Improvement</option>
          </select>
        </div>
        <div class="grid grid-2">
          <div class="form-group">
            <label>Age (years)</label>
            <input type="number" id="age" placeholder="25"/>
          </div>
          <div class="form-group">
            <label>Gender</label>
            <select id="gender">
              <option value="male">Male</option>
              <option value="female">Female</option>
            </select>
          </div>
        </div>
        <div class="grid grid-2">
          <div class="form-group">
            <label>Weight (kg)</label>
            <input type="number" id="weight" placeholder="70"/>
          </div>
          <div class="form-group">
            <label>Height (cm)</label>
            <input type="number" id="height" placeholder="170"/>
          </div>
        </div>
        <div class="form-group">
          <label>Activity Level</label>
          <select id="activity">
            <option value="sedentary">Sedentary (desk job, little exercise)</option>
            <option value="lightly active">Lightly Active (1‚Äì3 days/week)</option>
            <option value="moderately active" selected>Moderately Active (3‚Äì5 days/week)</option>
            <option value="very active">Very Active (6‚Äì7 days/week)</option>
            <option value="extremely active">Extremely Active (physical job + training)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Dietary Preference</label>
          <select id="diet_type">
            <option value="No restriction">No Restriction</option>
            <option value="Vegetarian">Vegetarian</option>
            <option value="Vegan">Vegan</option>
            <option value="Keto">Keto</option>
            <option value="Gluten-free">Gluten-Free</option>
            <option value="Diabetic-friendly">Diabetic-Friendly</option>
          </select>
        </div>
        <button class="btn btn-primary w-full" id="planBtn" onclick="generatePlan()">
          <i class="fa-solid fa-apple-whole"></i> Generate My Plan
        </button>
      </div>
    </div>

    <!-- Tips -->
    <div class="card mt-4">
      <div class="card-label">Quick Tips</div>
      <div class="mt-3" style="display:flex;flex-direction:column;gap:12px">
        <div class="flex items-center gap-3">
          <span style="font-size:1.4rem">üíß</span>
          <div class="text-sm">Drink 8+ glasses of water daily. Hydration is key to metabolism.</div>
        </div>
        <div class="flex items-center gap-3">
          <span style="font-size:1.4rem">ü•ó</span>
          <div class="text-sm">Fill half your plate with vegetables and whole foods.</div>
        </div>
        <div class="flex items-center gap-3">
          <span style="font-size:1.4rem">üïê</span>
          <div class="text-sm">Eat at consistent times to regulate your body clock.</div>
        </div>
        <div class="flex items-center gap-3">
          <span style="font-size:1.4rem">üò¥</span>
          <div class="text-sm">Quality sleep is essential for fitness progress and recovery.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Plan Result -->
  <div id="planArea">
    <div class="card" style="text-align:center;padding:60px 24px">
      <i class="fa-solid fa-apple-whole" style="font-size:3rem;color:var(--accent3);opacity:0.3;display:block;margin-bottom:20px"></i>
      <div style="font-family:'Syne',sans-serif;font-size:1.1rem;font-weight:700;margin-bottom:8px">Your Plan Awaits</div>
      <div class="text-muted text-sm">Fill in your profile details and click "Generate My Plan" to receive a personalized nutrition and workout plan.</div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function generatePlan() {
  const age = document.getElementById('age').value;
  const weight = document.getElementById('weight').value;
  const height = document.getElementById('height').value;
  if (!age || !weight || !height) {
    showToast('Please fill in age, weight, and height', 'error');
    return;
  }

  const btn = document.getElementById('planBtn');
  btn.disabled = true;
  btn.innerHTML = '<div class="spinner" style="border-color:rgba(0,0,0,0.2);border-top-color:#000;margin:0 auto"></div>';

  document.getElementById('planArea').innerHTML = `
    <div class="card" style="text-align:center;padding:60px">
      <div class="spinner" style="width:40px;height:40px;border-width:3px;margin:0 auto 20px"></div>
      <div style="color:var(--muted)">AI is crafting your personalized plan...</div>
    </div>`;

  try {
    const res = await fetch('/api/diet-plan', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        goal: document.getElementById('goal').value,
        age, weight, height,
        gender: document.getElementById('gender').value,
        activity: document.getElementById('activity').value,
        diet_type: document.getElementById('diet_type').value
      })
    });
    const data = await res.json();
    document.getElementById('planArea').innerHTML = `
      <div class="card">
        <div class="flex justify-between items-center mb-4">
          <div>
            <div class="card-label">AI Generated Plan</div>
            <div class="card-title mt-1">Your Personalized Diet & Fitness Plan</div>
          </div>
          <span class="badge badge-success">Gemini AI</span>
        </div>
        <div class="ai-response" id="planContent"></div>
        <div class="mt-4 flex gap-2" style="flex-wrap:wrap">
          <button class="btn btn-ghost" onclick="location.reload()"><i class="fa-solid fa-rotate"></i> New Plan</button>
          <a href="/chat" class="btn btn-primary"><i class="fa-solid fa-robot"></i> Discuss with AI</a>
        </div>
      </div>`;
    document.getElementById('planContent').innerHTML = marked.parse(data.result);
    showToast('Plan generated!', 'success');
  } catch(e) {
    showToast('Failed to generate plan. Try again.', 'error');
  }
  btn.disabled = false;
  btn.innerHTML = '<i class="fa-solid fa-apple-whole"></i> Generate My Plan';
}
</script>
{% endblock %}