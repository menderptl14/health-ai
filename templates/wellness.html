{% extends "base.html" %}
{% block title %}Mental Wellness{% endblock %}
{% block page_title %}Mental Wellness{% endblock %}
{% block page_subtitle %}Track your mood, journal your thoughts, and receive AI coping support{% endblock %}

{% block extra_head %}
<style>
.emoji-slider {
  display: flex;
  justify-content: space-between;
  gap: 8px;
  margin: 16px 0;
}
.emoji-btn {
  flex: 1;
  aspect-ratio: 1;
  max-width: 60px;
  border-radius: 12px;
  border: 2px solid var(--border);
  background: var(--surface);
  font-size: 1.4rem;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
}
.emoji-btn:hover { transform: scale(1.1); }
.emoji-btn.selected {
  border-color: var(--accent);
  background: rgba(56,189,248,0.15);
  transform: scale(1.15);
  box-shadow: 0 0 16px rgba(56,189,248,0.3);
}

.mood-entry {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 14px 0;
  border-bottom: 1px solid var(--border);
}
.mood-entry:last-child { border-bottom: none; }
.mood-emoji-display {
  width: 44px; height: 44px;
  border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.4rem;
  background: var(--surface);
  border: 1px solid var(--border);
  flex-shrink: 0;
}

.mood-score-bar {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 4px;
}
.mood-score-bar .bar {
  flex: 1;
  height: 4px;
  background: var(--border);
  border-radius: 2px;
  overflow: hidden;
}
.mood-score-bar .bar-fill {
  height: 100%;
  border-radius: 2px;
}
</style>
{% endblock %}

{% block content %}
<div class="grid grid-2">
  <!-- Log Mood -->
  <div>
    <div class="card">
      <div class="card-label">How are you feeling?</div>
      <div class="card-title mt-1">Log Today's Mood</div>

      <div class="emoji-slider mt-4">
        <button class="emoji-btn" onclick="selectMood(1, this)" title="Very Bad">ğŸ˜­</button>
        <button class="emoji-btn" onclick="selectMood(2, this)" title="Bad">ğŸ˜¢</button>
        <button class="emoji-btn" onclick="selectMood(3, this)" title="Sad">ğŸ˜Ÿ</button>
        <button class="emoji-btn" onclick="selectMood(4, this)" title="Low">ğŸ˜•</button>
        <button class="emoji-btn" onclick="selectMood(5, this)" title="Okay">ğŸ˜</button>
        <button class="emoji-btn" onclick="selectMood(6, this)" title="Decent">ğŸ™‚</button>
        <button class="emoji-btn" onclick="selectMood(7, this)" title="Good">ğŸ˜Š</button>
        <button class="emoji-btn" onclick="selectMood(8, this)" title="Great">ğŸ˜„</button>
        <button class="emoji-btn" onclick="selectMood(9, this)" title="Amazing">ğŸ¤©</button>
        <button class="emoji-btn" onclick="selectMood(10, this)" title="Perfect">ğŸ¥³</button>
      </div>

      <div id="moodLabel" style="text-align:center;font-size:1.1rem;font-weight:700;min-height:28px;color:var(--accent)"></div>

      <div class="form-group mt-4">
        <label>Journal Note (Optional)</label>
        <textarea id="moodNote" rows="4" placeholder="How was your day? What's on your mind? Write freely..."></textarea>
      </div>

      <input type="hidden" id="selectedMood" value="0"/>
      <button class="btn btn-primary w-full" onclick="logMood()">
        <i class="fa-solid fa-heart"></i> Save Mood & Get AI Support
      </button>
    </div>

    <!-- Mood Chart -->
    <div class="card mt-4">
      <div class="card-label">Last 14 Days</div>
      <div class="card-title mt-1">Mood Trend</div>
      <div style="height:180px;margin-top:16px">
        <canvas id="moodChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Right Panel -->
  <div>
    <div id="adviceArea">
      <div class="card" style="text-align:center;padding:60px 24px">
        <span style="font-size:3.5rem;display:block;margin-bottom:16px">ğŸ’™</span>
        <div style="font-family:'Syne',sans-serif;font-size:1.1rem;font-weight:700;margin-bottom:8px">Your Wellness Space</div>
        <div class="text-muted text-sm">Log your mood above to receive personalized coping strategies, mindfulness tips, and compassionate AI support.</div>
      </div>
    </div>

    <!-- Mood History -->
    <div class="card mt-4">
      <div class="card-label">Recent Entries</div>
      <div class="card-title mt-1">Mood History</div>
      <div class="mt-3">
        {% if moods %}
          {% for m in moods[:6] %}
          <div class="mood-entry">
            <div class="mood-emoji-display">
              {% set emojis = ['', 'ğŸ˜­','ğŸ˜¢','ğŸ˜Ÿ','ğŸ˜•','ğŸ˜','ğŸ™‚','ğŸ˜Š','ğŸ˜„','ğŸ¤©','ğŸ¥³'] %}
              {{ emojis[m.mood] if m.mood <= 10 else 'ğŸ˜' }}
            </div>
            <div style="flex:1;min-width:0">
              <div style="font-size:0.8rem;color:var(--muted)">{{ m.date[:10] }}</div>
              <div class="mood-score-bar">
                <span style="font-size:0.78rem;font-weight:700">{{ m.mood }}/10</span>
                <div class="bar">
                  <div class="bar-fill" style="width:{{ m.mood * 10 }}%;background:{% if m.mood >= 7 %}var(--accent3){% elif m.mood >= 4 %}#fbbf24{% else %}var(--danger){% endif %}"></div>
                </div>
              </div>
              {% if m.note %}
              <div class="text-sm text-muted" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:2px">{{ m.note }}</div>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div style="text-align:center;padding:24px;color:var(--muted)">
            <i class="fa-solid fa-face-smile-beam" style="font-size:2rem;opacity:0.3;margin-bottom:10px;display:block"></i>
            No mood logs yet. Start tracking today!
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let selectedMood = 0;
const labels = ['', 'Very Bad ğŸ˜­', 'Bad ğŸ˜¢', 'Sad ğŸ˜Ÿ', 'Low ğŸ˜•', 'Okay ğŸ˜', 'Decent ğŸ™‚', 'Good ğŸ˜Š', 'Great ğŸ˜„', 'Amazing ğŸ¤©', 'Perfect ğŸ¥³'];

function selectMood(val, btn) {
  document.querySelectorAll('.emoji-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  selectedMood = val;
  document.getElementById('selectedMood').value = val;
  document.getElementById('moodLabel').textContent = labels[val] || '';
}

async function logMood() {
  if (!selectedMood) { showToast('Please select a mood emoji first', 'error'); return; }
  const note = document.getElementById('moodNote').value;

  // Save mood
  await fetch('/api/log-mood', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({mood: selectedMood, note})
  });

  showToast('Mood logged!', 'success');

  // Get AI advice
  document.getElementById('adviceArea').innerHTML = `
    <div class="card" style="text-align:center;padding:60px">
      <div class="spinner" style="width:40px;height:40px;border-width:3px;margin:0 auto 20px"></div>
      <div style="color:var(--muted)">AI is preparing your wellness support...</div>
    </div>`;

  try {
    const res = await fetch('/api/wellness-advice', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({mood: selectedMood, note})
    });
    const data = await res.json();
    document.getElementById('adviceArea').innerHTML = `
      <div class="card">
        <div class="flex justify-between items-center mb-4">
          <div>
            <div class="card-label">AI Wellness Support</div>
            <div class="card-title mt-1">Personalized Coping Strategies</div>
          </div>
          <span class="badge badge-info">Gemini AI</span>
        </div>
        <div class="ai-response" id="wellnessContent"></div>
      </div>`;
    document.getElementById('wellnessContent').innerHTML = marked.parse(data.result);
  } catch(e) {
    showToast('Failed to get AI advice', 'error');
  }
}

// Mood chart
const moods = {{ moods | tojson }};
const ctx = document.getElementById('moodChart').getContext('2d');
const chartData = moods.slice().reverse();
new Chart(ctx, {
  type: 'bar',
  data: {
    labels: chartData.map(m => m.date ? m.date.slice(5,10) : ''),
    datasets: [{
      data: chartData.map(m => m.mood),
      backgroundColor: chartData.map(m =>
        m.mood >= 7 ? 'rgba(52,211,153,0.6)' :
        m.mood >= 4 ? 'rgba(251,191,36,0.6)' : 'rgba(248,113,113,0.6)'
      ),
      borderRadius: 6,
      borderSkipped: false
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { display: false } },
    scales: {
      y: {
        min: 0, max: 10,
        grid: { color: 'rgba(255,255,255,0.04)' },
        ticks: { color: '#7a92b0', font: { size: 11 } }
      },
      x: {
        grid: { display: false },
        ticks: { color: '#7a92b0', font: { size: 10 } }
      }
    }
  }
});
</script>
{% endblock %}