{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block page_title %}Dashboard{% endblock %}
{% block page_subtitle %}Welcome back, {{ user.name }}! Here's your health overview.{% endblock %}

{% block extra_head %}
<style>
.health-score-ring {
  position: relative;
  width: 140px;
  height: 140px;
  margin: 0 auto 16px;
}
.health-score-ring svg { transform: rotate(-90deg); }
.health-score-ring .ring-bg { stroke: var(--border); }
.health-score-ring .ring-fill {
  stroke: url(#scoreGradient);
  stroke-linecap: round;
  transition: stroke-dashoffset 1.5s ease;
}
.ring-label {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}
.ring-label .score-num {
  font-family: 'Syne', sans-serif;
  font-size: 2rem;
  font-weight: 800;
  color: var(--accent);
  display: block;
}
.ring-label .score-text {
  font-size: 0.65rem;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.08em;
}

.metric-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  display: flex;
  align-items: center;
  gap: 16px;
  transition: all 0.2s;
}
.metric-card:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.3); }
.metric-icon {
  width: 48px; height: 48px;
  border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.2rem;
  flex-shrink: 0;
}
.metric-val { font-family: 'Syne', sans-serif; font-size: 1.5rem; font-weight: 800; }
.metric-label { font-size: 0.75rem; color: var(--muted); }

.ai-tip {
  background: linear-gradient(135deg, rgba(56,189,248,0.08), rgba(129,140,248,0.08));
  border: 1px solid rgba(56,189,248,0.15);
  border-radius: 12px;
  padding: 14px 18px;
  display: flex;
  align-items: flex-start;
  gap: 12px;
  margin-bottom: 10px;
  font-size: 0.875rem;
  line-height: 1.6;
}
.ai-tip i { color: var(--accent); margin-top: 2px; flex-shrink: 0; }

.reminder-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 0;
  border-bottom: 1px solid var(--border);
}
.reminder-item:last-child { border-bottom: none; }
.reminder-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

.progress-bar-wrap { margin-top: 8px; }
.progress-bar {
  height: 6px;
  background: var(--border);
  border-radius: 3px;
  overflow: hidden;
}
.progress-bar-fill {
  height: 100%;
  border-radius: 3px;
  background: linear-gradient(90deg, var(--accent), var(--accent2));
  transition: width 1s ease;
}

.update-form { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 16px; }
.update-form input {
  flex: 1;
  min-width: 80px;
  padding: 8px 12px;
  font-size: 0.8rem;
}
</style>
{% endblock %}

{% block content %}
<!-- Metric Cards -->
<div class="grid grid-4 mb-4">
  <div class="metric-card">
    <div class="metric-icon" style="background:rgba(56,189,248,0.12);color:var(--accent)">
      <i class="fa-solid fa-weight-scale"></i>
    </div>
    <div>
      <div class="metric-label">BMI</div>
      <div class="metric-val">{{ bmi or 'â€”' }}</div>
      <div class="text-sm text-muted">{{ bmi_cat }}</div>
    </div>
  </div>
  <div class="metric-card">
    <div class="metric-icon" style="background:rgba(52,211,153,0.12);color:var(--accent3)">
      <i class="fa-solid fa-person-walking"></i>
    </div>
    <div>
      <div class="metric-label">Steps Today</div>
      <div class="metric-val" data-counter="{{ health.steps or 0 }}">{{ health.steps or 0 }}</div>
    </div>
  </div>
  <div class="metric-card">
    <div class="metric-icon" style="background:rgba(129,140,248,0.12);color:var(--accent2)">
      <i class="fa-solid fa-droplet"></i>
    </div>
    <div>
      <div class="metric-label">Water Intake</div>
      <div class="metric-val">{{ health.water_ml or 0 }}<span style="font-size:0.9rem">ml</span></div>
    </div>
  </div>
  <div class="metric-card">
    <div class="metric-icon" style="background:rgba(251,146,60,0.12);color:#fb923c">
      <i class="fa-solid fa-moon"></i>
    </div>
    <div>
      <div class="metric-label">Sleep</div>
      <div class="metric-val">{{ health.sleep_hours or 0 }}<span style="font-size:0.9rem">hr</span></div>
    </div>
  </div>
</div>

<div class="grid grid-3">
  <!-- Health Score -->
  <div class="card" style="text-align:center">
    <div class="card-label">AI Health Score</div>
    <div class="health-score-ring mt-3" id="scoreRing">
      <svg width="140" height="140" viewBox="0 0 140 140">
        <defs>
          <linearGradient id="scoreGradient" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#38bdf8"/>
            <stop offset="100%" stop-color="#818cf8"/>
          </linearGradient>
        </defs>
        <circle class="ring-bg" cx="70" cy="70" r="58" fill="none" stroke-width="10"/>
        <circle class="ring-fill" id="ringFill" cx="70" cy="70" r="58" fill="none" stroke-width="10"
          stroke-dasharray="364.4" stroke-dashoffset="364.4"/>
      </svg>
      <div class="ring-label">
        <span class="score-num" id="scoreNum">â€”</span>
        <span class="score-text">/ 100</span>
      </div>
    </div>
    <div class="mt-2 text-sm" id="scoreDesc" style="color:var(--muted)">Calculating...</div>
    <div class="progress-bar-wrap mt-3">
      <div class="flex justify-between text-sm mb-1">
        <span class="text-muted">Steps Goal (8000)</span>
        <span class="text-accent">{{ health.steps or 0 }}/8000</span>
      </div>
      <div class="progress-bar">
        <div class="progress-bar-fill" style="width:{{ [(health.steps or 0)/80, 100] | min }}%"></div>
      </div>
    </div>
    <div class="progress-bar-wrap mt-2">
      <div class="flex justify-between text-sm mb-1">
        <span class="text-muted">Hydration (2000ml)</span>
        <span class="text-accent">{{ health.water_ml or 0 }}/2000</span>
      </div>
      <div class="progress-bar">
        <div class="progress-bar-fill" style="width:{{ [(health.water_ml or 0)/20, 100] | min }}%;background:linear-gradient(90deg,var(--accent2),var(--accent3))"></div>
      </div>
    </div>
  </div>

  <!-- Mood Chart -->
  <div class="card">
    <div class="card-label">Mood Trend (Last 7 Days)</div>
    <div class="card-title mt-1">Mental Wellness</div>
    <div style="height:200px;margin-top:16px">
      <canvas id="moodChart"></canvas>
    </div>
    <a href="/wellness" class="btn btn-ghost w-full mt-3" style="justify-content:center;font-size:0.8rem">
      <i class="fa-solid fa-arrow-right"></i> Log Today's Mood
    </a>
  </div>

  <!-- Reminders -->
  <div class="card">
    <div class="flex justify-between items-center mb-4">
      <div>
        <div class="card-label">Upcoming</div>
        <div class="card-title">Reminders</div>
      </div>
      <a href="/reminders" class="btn btn-ghost" style="font-size:0.78rem;padding:7px 14px">Manage</a>
    </div>
    {% if reminders %}
      {% for r in reminders %}
      <div class="reminder-item">
        <div class="reminder-dot" style="background:{% if r.type=='medicine' %}var(--accent){% elif r.type=='water' %}var(--accent2){% else %}var(--accent3){% endif %}"></div>
        <div style="flex:1">
          <div style="font-size:0.875rem;font-weight:600">{{ r.title }}</div>
          <div class="text-sm text-muted">{{ r.time }} Â· {{ r.type|title }}</div>
        </div>
        <i class="fa-solid fa-bell text-sm" style="color:var(--muted)"></i>
      </div>
      {% endfor %}
    {% else %}
      <div style="text-align:center;padding:30px 0;color:var(--muted)">
        <i class="fa-solid fa-bell-slash" style="font-size:2rem;margin-bottom:12px;display:block;opacity:0.4"></i>
        <div class="text-sm">No reminders set</div>
        <a href="/reminders" class="btn btn-ghost mt-3" style="font-size:0.78rem">Add Reminder</a>
      </div>
    {% endif %}
  </div>
</div>

<!-- Update Health Data -->
<div class="card mt-4">
  <div class="flex justify-between items-center">
    <div>
      <div class="card-label">Daily Tracker</div>
      <div class="card-title">Update Today's Health Data</div>
    </div>
    <i class="fa-solid fa-pen-to-square text-accent"></i>
  </div>
  <div class="update-form">
    <div class="form-group" style="flex:1;min-width:140px;margin:0">
      <label>Steps</label>
      <input type="number" id="inp-steps" placeholder="{{ health.steps or 0 }}" value="{{ health.steps or '' }}"/>
    </div>
    <div class="form-group" style="flex:1;min-width:140px;margin:0">
      <label>Water (ml)</label>
      <input type="number" id="inp-water" placeholder="{{ health.water_ml or 0 }}" value="{{ health.water_ml or '' }}"/>
    </div>
    <div class="form-group" style="flex:1;min-width:140px;margin:0">
      <label>Sleep (hrs)</label>
      <input type="number" id="inp-sleep" step="0.5" placeholder="{{ health.sleep_hours or 0 }}" value="{{ health.sleep_hours or '' }}"/>
    </div>
    <div style="display:flex;align-items:flex-end;padding-bottom:0">
      <button class="btn btn-primary" onclick="saveHealthData()">
        <i class="fa-solid fa-save"></i> Save
      </button>
    </div>
  </div>
</div>

<!-- AI Tips -->
<div class="card mt-4">
  <div class="flex justify-between items-center mb-4">
    <div>
      <div class="card-label">AI Insights</div>
      <div class="card-title">Personalized Health Tips</div>
    </div>
    <span class="badge badge-info">AI Generated</span>
  </div>
  <div class="ai-tip"><i class="fa-solid fa-lightbulb"></i>Stay hydrated! Aim for at least 8 glasses of water daily. Proper hydration improves focus, energy, and metabolic function.</div>
  <div class="ai-tip"><i class="fa-solid fa-lightbulb"></i>Regular movement matters. Even a 10-minute walk every hour can significantly reduce the health risks of prolonged sitting.</div>
  <div class="ai-tip"><i class="fa-solid fa-lightbulb"></i>Prioritize 7â€“9 hours of quality sleep. Sleep is when your body repairs tissues and consolidates memory.</div>
  <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
    <a href="/chat" class="btn btn-primary"><i class="fa-solid fa-robot"></i> Ask AI Assistant</a>
    <a href="/symptoms" class="btn btn-ghost"><i class="fa-solid fa-stethoscope"></i> Analyze Symptoms</a>
    <a href="/diet" class="btn btn-ghost"><i class="fa-solid fa-apple-whole"></i> Diet Planner</a>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Health Score
fetch('/api/health-score')
  .then(r => r.json())
  .then(d => {
    const score = d.score;
    document.getElementById('scoreNum').textContent = score;
    const circumference = 364.4;
    const offset = circumference - (score / 100) * circumference;
    document.getElementById('ringFill').style.strokeDashoffset = offset;
    let desc = 'ðŸ”´ Needs Improvement';
    if (score >= 80) desc = 'ðŸŸ¢ Excellent Health';
    else if (score >= 60) desc = 'ðŸŸ¡ Good Health';
    else if (score >= 40) desc = 'ðŸŸ  Fair Health';
    document.getElementById('scoreDesc').textContent = desc;
  });

// Mood Chart
const moodData = {{ mood_data | tojson }};
const moodLabels = {{ mood_labels | tojson }};
const ctx = document.getElementById('moodChart').getContext('2d');
new Chart(ctx, {
  type: 'line',
  data: {
    labels: moodLabels.length ? moodLabels : ['No data'],
    datasets: [{
      label: 'Mood',
      data: moodData.length ? moodData : [0],
      fill: true,
      borderColor: '#38bdf8',
      backgroundColor: 'rgba(56,189,248,0.08)',
      tension: 0.4,
      pointBackgroundColor: '#818cf8',
      pointRadius: 5,
      borderWidth: 2
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { display: false } },
    scales: {
      y: {
        min: 1, max: 10,
        grid: { color: 'rgba(255,255,255,0.04)' },
        ticks: { color: '#7a92b0', font: { size: 11 } }
      },
      x: {
        grid: { display: false },
        ticks: { color: '#7a92b0', font: { size: 10 }, maxTicksLimit: 5 }
      }
    }
  }
});

// Save health data
function saveHealthData() {
  const data = {
    steps: parseInt(document.getElementById('inp-steps').value) || 0,
    water_ml: parseInt(document.getElementById('inp-water').value) || 0,
    sleep_hours: parseFloat(document.getElementById('inp-sleep').value) || 0
  };
  fetch('/api/health-data', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(data)
  }).then(() => {
    showToast('Health data updated!', 'success');
    setTimeout(() => location.reload(), 1000);
  });
}

// Animate counters
document.querySelectorAll('[data-counter]').forEach(el => {
  let start = 0;
  const target = parseFloat(el.dataset.counter);
  const step = target / 50;
  const t = setInterval(() => {
    start += step;
    if (start >= target) { start = target; clearInterval(t); }
    el.textContent = Math.round(start);
  }, 20);
});
</script>
{% endblock %}